# Объединённый CRM‑проект: Telegram‑бот и веб‑панель задач

Этот репозиторий содержит пример CRM‑решения, в котором совмещены две части:

1. **Telegram‑бот** (`crm_bot`) на базе `aiogram`. Он регистрирует пользователей по
   команде `/start`, позволяет создавать лиды (`/newlead`) и задачи (`/newtask`),
   выводить их списки (`/myleads`, `/mytasks`) и сохраняет данные в Supabase.
2. **Веб‑панель** (`crm_app`) — одностраничное React‑приложение, включающее
   админскую страницу для просмотра ответов опроса (из исходного проекта) и
   новую страницу *Задачи* (`/tasks`). Панель использует Supabase Auth для входа
   по корпоративной почте и предоставляет интерфейс для просмотра, фильтрации и
   создания задач в соответствии с ролями пользователя.

Проект построен на Supabase, поэтому бот и веб‑панель работают с одной и той же
базой данных и видят общие таблицы.

## 1. Предварительные требования

1. **Supabase** — зарегистрируйтесь на [supabase.com](https://supabase.com) и
   создайте новый проект. В настройках API получите `Project URL` и
   `Service Role` API‑ключ (или `Anon` ключ для фронтенда). Эти значения
   понадобятся в настройке приложений.
2. **Node.js** и **npm** — для запуска веб‑панели. Рекомендуем Node 18+.
3. **Python 3.9+** — для запуска Telegram‑бота.
4. **Git** (опционально) для управления версиями.

## 2. Развёртывание базы данных

В разделе **SQL Editor** вашей панели Supabase выполните SQL‑скрипт
`crm_bot/schema.sql` из этого репозитория. Он создаёт следующие таблицы:

- `users` — хранит Telegram‑ID, username и имя пользователя.
- `leads` — контакты клиентов (имя, телефон, e‑mail) и связь с пользователем.
- `messages` — журнал входящих/исходящих сообщений (опционально).
- `profiles` — профили пользователей Supabase (id, полное имя, Telegram‑ID и
  роль). Роль определяет уровень доступа: `project_head`, `team_leader`,
  `region_manager` или `junior_manager`.
- `tasks` — задачи CRM: название, клиент, дедлайн, описание, результат,
  статус, постановщик (assigner_telegram_id) и исполнитель
  (assignee_telegram_id), комментарии и временные отметки.
- `task_files` — позволяет хранить URL прикреплённых файлов для задач.

После создания таблиц настройте **Row Level Security** в Supabase. Для
простейшего запуска можно разрешить чтение и запись всем (`role = anon`),
однако в продакшене рекомендуется ограничить доступ согласно ролям и
привязке к пользователю.

## 3. Настройка Telegram‑бота (`crm_bot`)

### 3.1 Получение токена

Создайте нового бота у [@BotFather](https://t.me/BotFather) с помощью
команды `/newbot`. Укажите имя и username и получите строку вида
`123456:AA...` — это **BOT_TOKEN**. Telegram подчёркивает, что токен
является паролем и не должен публиковаться【222862539556652†L121-L129】.

### 3.2 Конфигурация

В каталоге `crm_bot` создайте файл `.env` и заполните его по примеру:

```env
BOT_TOKEN=<токен от BotFather>
SUPABASE_URL=https://<ваш‑проект>.supabase.co
SUPABASE_KEY=<service_role_key>
```

`SUPABASE_KEY` должен быть ключом с ролью `service_role`, чтобы бот мог
читать/записывать данные. Не публикуйте этот ключ на клиенте.

### 3.3 Установка зависимостей и запуск

```bash
cd crm_bot
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python bot.py
```

При запуске бот подключается к Supabase (`create_client(url, key)`)
【103787523269103†L133-L189】, инициализирует `aiogram`‑диспетчер и
регистрирует обработчики команд. Доступные команды:

- `/start` — регистрация пользователя (сохраняет `telegram_id` в `users`) и
  приветствие.
- `/newlead` — создание лида (пошагово: имя, телефон, e‑mail).
- `/myleads` — вывод списка ваших лидов.
- `/newtask` — создание новой задачи: бот спрашивает название, клиента,
  дедлайн, описание и telegram‑ID исполнителя (0 — назначить себе).
- `/mytasks` — показывает задачи, где вы являетесь постановщиком или
  исполнителем. Выводятся ID задачи, название, срок, статус и
  telegram‑ID исполнителя.
- `/help` — список команд.

### 3.4 Рассылка уведомлений (дополнительно)

Для отправки напоминаний о приближающихся дедлайнах можно использовать
Edge Functions Supabase. Создайте функцию, которая раз в несколько минут
выбирает задачи с дедлайном в ближайший час и отправляет сообщения через
Telegram API. Пример реализации опубликован в официальном примере
Supabase Telegram notifier【14†L269-L277】. В этом репозитории нет готовой
функции, но структура таблицы `tasks` предусматривает автоматический
переход задач в статус «Просрочена» после наступления дедлайна.

## 4. Настройка веб‑панели (`crm_app`)

### 4.1 Конфигурация

Панель использует `@supabase/supabase-js` для подключения к базе. Создайте
файл `.env` в каталоге `crm_app` и добавьте:

```env
VITE_SUPABASE_URL=https://<ваш‑проект>.supabase.co
VITE_SUPABASE_ANON_KEY=<anon_key>
```

Используйте **Anon** ключ, чтобы браузер‑клиент мог авторизоваться через
Supabase Auth. Ключ `service_role` здесь не нужен — его нельзя вставлять
во фронтенд.

### 4.2 Установка зависимостей и запуск

```bash
cd crm_app
npm install
npm run dev
```

После запуска Vite отобразит URL (обычно `http://localhost:5173`). В
браузере доступны следующие маршруты:

- `/` — страница опроса (примеры из исходного steampunk‑проекта).
- `/admin` — админ‑панель для просмотра ответов опроса. Вход по почте.
- `/tasks` — новая страница управления задачами. После входа по
  корпоративной почте (`@sds-group.ru`) отображается список задач,
  фильтры (по названию, клиенту и диапазону дат), пагинация и кнопка
  «Новая задача». Форма создания задачи позволяет указать название,
  клиента, дедлайн, описание и выбрать исполнителя из списка сотрудников
  (данные берутся из таблицы `profiles`).

Страница задач учитывает роль пользователя:

* **project_head** — видит все задачи.
* **team_leader** — видит свои задачи и задачи региональных/младших
  менеджеров.
* **region_manager** — видит свои задачи и задачи младших менеджеров.
* **junior_manager** — видит только свои задачи (созданные им или
  назначенные ему).

Роли задаются в таблице `profiles`. После регистрации нового пользователя
в Supabase Auth администратор должен создать запись в `profiles` и
назначить ему соответствующую роль, указав Telegram‑ID для связи с ботом.
Можно настроить триггер на `auth.users`, который ограничит регистрацию
почтовыми адресами с доменом `@sds-group.ru`【6†L219-L227】.

## 5. Организация проекта

```
combined_crm/
├── crm_app/      # фронтенд (React + Vite)
│   ├── src/Tasks.jsx   # страница задач (новая)
│   ├── src/Admin.jsx   # страница лидов из опросника
│   ├── src/App.jsx     # страница опроса (из исходного проекта)
│   ├── src/main.jsx    # роутер (добавлен путь /tasks)
│   └── ...
├── crm_bot/      # Telegram‑бот
│   ├── bot.py    # основной скрипт, поддерживает лиды и задачи
│   ├── schema.sql# SQL‑схема (пользователи, профили, лиды, задачи)
│   └── ...
└── README.md     # текущее руководство
```

## 6. Развёртывание в продакшене

### 6.1 Бот

На сервере Linux рекомендуется оформить бота как службу `systemd`. Пример unit
файла:

```
[Unit]
Description=CRM Telegram Bot
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/combined_crm/crm_bot
ExecStart=/usr/bin/python3 bot.py
EnvironmentFile=/opt/combined_crm/crm_bot/.env
Restart=always

[Install]
WantedBy=multi-user.target
```

### 6.2 Веб‑панель

Соберите фронтенд командой `npm run build` — Vite положит статические файлы
в каталог `dist`. Их можно раздать через любой веб‑сервер (Nginx, Netlify
и т.п.). Для серверной аутентификации Supabase вам понадобится настроить
домен редиректа в настройках проекта Supabase (Auth → URL Redirects).

## 7. Дополнительные улучшения

* **Подтверждение задач.** В текущей реализации бот и панель позволяют
  создавать задачи и просматривать их. Вы можете добавить команды `/reporttask`
  для отправки результата и `/approvetask` для подтверждения руководителем,
  изменяя поле `status` на `Результат на согласовании` и `Завершено`.
* **Уведомления.** Реализуйте CRON‑функцию в Supabase, чтобы отправлять
  напоминания за час до дедлайна и отмечать задачи как просроченные.
* **Хранение файлов.** Таблица `task_files` позволяет прикреплять
  изображения и документы к задачам. Используйте [Supabase Storage](https://supabase.com/docs/guides/storage)
  и сохраняйте URL файла в таблице.
* **RLS‑политики.** На продакшене настройте политики доступа, чтобы
  пользователи не могли читать чужие задачи. Например, запрещайте
  `SELECT` тем, кто не является постановщиком или исполнителем.

## 8. Ссылки на документацию

* Получение токена BotFather и рекомендации по безопасности — офиц. док.
  Telegram【222862539556652†L121-L129】.
* Установка Supabase‑py и создание клиента — офиц. документация
  Supabase【103787523269103†L133-L189】.
* Пример SQL‑создания таблицы телеграм‑пользователей — шаблон n8n
  (использован как ориентир)【842125258632519†L117-L127】.
* Настройка ограничения регистрации по домену почты через триггер
  `auth.users`【6†L219-L227】.
* Пример реализации Edge Function для отправки Telegram‑уведомлений
  опубликован в официальном репозитории Supabase【14†L269-L277】.

---

Этот проект предоставляет основу для CRM‑решения. Вы можете расширять
функциональность (например, добавлять статусы задач, роли, панель
управления клиентами) и адаптировать дизайн под свои задачи. Всё
исходное содержимое steampunk‑проекта сохранено, а новая страница
`/tasks` органично дополняет его функциональность.

## 9. Дополнительное руководство

Подробные инструкции по назначению ролей, выдаче прав, использованию
кнопочного интерфейса бота и управлению задачами через Supabase
описаны в файле [`BOT_SUPABASE_MANUAL.md`](BOT_SUPABASE_MANUAL.md). Он
объясняет, как настроить таблицы `profiles` и `tasks`, назначать
исполнителей по ФИО, изменять статусы задач и работать с веб‑панелью.